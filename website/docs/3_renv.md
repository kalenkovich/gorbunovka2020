# renv

R-пакет renv - система управления пакетами R.
То, что мы делали для питона, его пакетов, R и потенциально другого софта с помощью conda, для R мы будем делать с помощью renv.
renv выполняет гораздо более ограниченную функцию, чем conda - он только следит за пакетами R.
Зато работа с ним гораздо проще для пользователя:

- один единственный файл `renv.lock` вместо `environment.yml` и `environment-full.yml`,
- `renv.lock` пополняется программно - не нужно ничего править руками,
- удаление пакета или откат к предыдущему состоянию не принуждает нас восстанавливать весь энвайронмент с нуля,
- если мы запускаем R/RStudio из корня репозитория, то renv не нужно отдельно активировать,
- точно еще что-то, чего я пока не вспомнил.

При работе с renv по большей части достаточно будет выучить три команды:

- `renv::init(bare = TRUE, settings = list(snapshot.type = 'all'))` - инициализация renv в текущей папке (как раз создадутся все файлы/папки, которые мы обсуждали выше).

	> Я советую запускать `init` именно с параметром `bare=TRUE`, который говорит что не надо пока в библиотеку `renv/library` ничего устанавливать.
	> В противном случае renv попытается сохранить в проект все библиотеки, которые у нас уже установлены (в библиотеке R нашего condsa-энвайронмента), а также пройтись по всем R-файлам (`.r`, `.rmd`), которые у нас есть в репозитории, и выцепить оттуда все пакеты R, которые вы в них загржаете.
	> Гораздо лучше брать этот процесс в свои руки: установили пакет, отметили его в renv (см. ниже), закоммитили.
	> Также рекоммендую проставлять `settings = list(snapshot.type = 'all')`. Этот параметр перекликается с первым: он говорит, что renv должен сохранять версии всех установленных пакетов, а не только тех, которые упоминаются в ваших скриптах.

- `renv::snapshot()` - сохранить текущее состояние библиотеки в `renv.lock`
- `renv::restore(clean = TRUE)` - восстановить состояние библиотеки до состояния, сохраненного в `renv.lock`. Без `clean = TRUE` пакеты будут доустанавливаться, но не удаляться.

Подробнее можно прочитать про renv на его [страничке](https://rstudio.github.io/renv/index.html) или в виньетке ["Introduction to renv"](https://rstudio.github.io/renv/articles/renv.html).

*Задание*

- Установите renv:

	- Активируйте наш энвайронмент.
	- Запустите R (`r` в терминале) в корне репозитория.
	- Установите renv

		```r
		install.packages('renv')
		```
	
- Инициализируйте renv:

	```r
	renv::init(bare = TRUE, settings = list(snapshot.type = 'all'))
	```


- Перезапустите R (`quit()` -> `n` -> `r`).
- Сохраните состояние в renv (`renv::snapshot()`).
- Закоммитьте следующие файлы:
    - `.Rprofile`
	- `renv.lock`
	- `renv/activate.r`
	- `renv/setings.dcs`
	- `renv/.gitignore`


Вот, что мы только что закоммитили (и что - нет):

- `.Rprofile` - скрипт, который активирует renv, когда R запускается из корня репозитория.
- `renv.lock` - файл со списком пакетов, их версий и того, откуда они были взяты.
- `renv/activate.R` - скрипт-помощник, который активирует renv; именно его вызывает `.Rprofile`.
- `renv/library` - тут хранятся все пакеты вашего проекта.
Мы не будем коммитить в git ничего из этой папки.
`renv` знает об этом, поэтому создает еще следующий файл.
- `renv/.gitignore` - этот файл говорит git, на какие файлы можно закрыть глаза.
- `renv/settings.`


## Установка нового пакета `x`

Я советую следующий порядок действий:

- `install.packages('x')`,
- `renv::snapshot()`,
- закоммитьте изменения.

> Я часто после установки пакета не сохраняю его, потому что хочу сначала убедиться, что он мне действительно подходит и нужен.
> Не делайте так: в 50% случаев я забываю его сохранить, а потом удивляюсь, почему "я ничего не менял, оно все работало, а теперь не работает".
> Не надо так делать.

*Задание*

- Установите пакет `remotes`.


По-дефолту, R устанавливает пакеты из хранилища пакетов под названием [CRAN](https://cran.r-project.org/).
Некоторые пакеты пока не удостоились чести быть добавленными в CRAN, поэтому их приходится устанавливать откуда-нибудь еще.
Например, с GitHub.
Именно этим и занимается пакет `remotes`, который мы установили выше.
Почти всегда в этом случае на страничке репозитория на GitHub будет написано, как именно это сделать.

*Задание*

- Зайдите на [страничку на GitHub](https://github.com/crsh/papaja) пакета papaja.
- Найдите команду, которая его устанавливает (не используйте её пока!).

Обратите внимание, что команда, которую вы нашли, использует пакет devtools, а не remotes.
Так будет часто с пакетами, размещенными на GitHub.
Советую не слушать никого и использовать вместо этого remotes - меньше лишних пакетов будет установлено.
Просто возьмите командру, рекоммендуемую автором пакета, и замените в ней `devtools` на `remotes`.

*Задание*

- Установите papaja, используя remotes.
Если будут предлагать установить какой-нибудь пакет из исходников - не ведитесь, отвечайте "no".
Если будут предлагать обновить что-нибудь - выбирайте "3: None".
- Каждый раз, когда установка будет ломаться, найдите причину в сообщении.
    - игнорируйте ошибки, помеченные как `converted from warning`.
    - Если проблема возникла при установке какого-то пакета - попробуйте установить его отдельно (не забудь сделать снэпшот, закоммитить и пометить в сообщении, что это все ради papaja).
    - Отдельно для Windows:
		- Если ругается, что `gcc: command not found`, то нужно установать [RTools 4.0](https://cran.r-project.org/bin/windows/Rtools/) (для R версии 4 и выше).
		Если ваша версия R старше, то по ссылке выше поищите ссылку на RTools для более старых версий.
		- Если говорит, что нужно установать RTools 4.0, то нужно установать [RTools 4.0](https://cran.r-project.org/bin/windows/Rtools/) (для R версии 4 и выше)
		- Если вы уже установили RTools, а он все равно чего-то хочет:
			- установите пакет `pkgbuild`
			- каждую команду для установки пакетов вставьте в следующий код:
				```r
				pkgbuild::with_build_tools({<ваша-команда>})
				```


## Удаление пакета `x`

В отличие от conda здесь удаление происходит симметрично (ну, почти) по отношению к установке:

- `remove.packages('x')`,
- `renv::snapshot()`,
- закоммитьте изменения.
